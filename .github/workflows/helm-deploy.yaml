name: Deploy to K8s with Helm

on:
  workflow_dispatch:  # Manual Trigger
    inputs:
      imageTag:
        description: "Docker Image Tag"
        required: true
        default: "latest"

  repository_dispatch:  # Trigger à¸œà¹ˆà¸²à¸™ API
    types: [deploy-k8s]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ðŸ”¹ Login to Kubernetes Cluster
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.26.0

      - name: Create .kube directory
        run: |
          mkdir -p $HOME/.kube

      - name: Set up KUBECONFIG
        run: |
          echo "${{ secrets.KUBE_TOKEN }}" | base64 --decode > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          ls -l $HOME/.kube/config

      # ðŸ”¹ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š Kubernetes
      - name: Check kubectl connection
        run: |
          kubectl get nodes

      # ðŸ”¹ à¸­à¹ˆà¸²à¸™à¸„à¹ˆà¸² `image.repository` à¹à¸¥à¸° `image.tag` à¸ˆà¸²à¸ `app1/values.yml`
      - name: Read image from app1/values.yml
        id: read_values
        run: |
          ls -lrt
          IMAGE_REPO=$(yq e '.image.repository' ./app1/values.yaml)
          IMAGE_TAG=$(yq e '.image.tag' ./app1/values.yaml)
          echo "IMAGE_REPO=$IMAGE_REPO"
          echo "IMAGE_TAG=$IMAGE_TAG"
          echo "IMAGE_REPO=$IMAGE_REPO" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # ðŸ”¹ Deploy à¸”à¹‰à¸§à¸¢ Helm
      - name: Deploy with Helm
        run: |
          IMAGE_TAG=${{ github.event.inputs.imageTag || github.event.client_payload.imageTag || env.IMAGE_TAG }}
          IMAGE_REPO=${{ env.IMAGE_REPO }}

          helm upgrade --install app1 ./app1 \
            --namespace  testdeploy --create-namespace \
            --set image.repository=$IMAGE_REPO \
            --set image.tag=$IMAGE_TAG