name: Deploy to K8s with Helm

on:
  workflow_dispatch:  # Manual Trigger
    inputs:
      imageTag:
        description: "Docker Image Tag"
        required: true
        default: "latest"

  repository_dispatch:  # Trigger à¸œà¹ˆà¸²à¸™ API
    types: [deploy-k8s]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ðŸ”¹ Login to Kubernetes Cluster
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.26.0

      - name: Authenticate with K8s
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > kubeconfig
          export KUBECONFIG=$(pwd)/kubeconfig

      - name: List directory contents
        run: |
          ls -R

      # ðŸ”¹ à¸­à¹ˆà¸²à¸™à¸„à¹ˆà¸² `image.repository` à¹à¸¥à¸° `image.tag` à¸ˆà¸²à¸ `app1/values.yml`
      - name: Read image from app1/values.yml
        id: read_values
        run: |
          ls -lrt
          IMAGE_REPO=$(yq e '.image.repository' ./app1/values.yml)
          IMAGE_TAG=$(yq e '.image.tag' ./app1/values.yml)
          echo "IMAGE_REPO=$IMAGE_REPO"
          echo "IMAGE_TAG=$IMAGE_TAG"
          echo "IMAGE_REPO=$IMAGE_REPO" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV